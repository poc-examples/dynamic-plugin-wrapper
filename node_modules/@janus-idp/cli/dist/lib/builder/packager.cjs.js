'use strict';

var chalk = require('chalk');
var fs = require('fs-extra');
var rollup = require('rollup');
var path = require('path');
var paths = require('../paths.cjs.js');
var buildTypeDefinitions = require('./buildTypeDefinitions.cjs.js');
var config = require('./config.cjs.js');
var types = require('./types.cjs.js');

function _interopDefaultCompat (e) { return e && typeof e === 'object' && 'default' in e ? e : { default: e }; }

var chalk__default = /*#__PURE__*/_interopDefaultCompat(chalk);
var fs__default = /*#__PURE__*/_interopDefaultCompat(fs);

function formatErrorMessage(error) {
  let msg = "";
  if (error.code === "PLUGIN_ERROR") {
    if (error.plugin === "esbuild") {
      msg += `${error.message}`;
      if (error.errors?.length) {
        msg += `

`;
        for (const { text, location } of error.errors) {
          const { line, column } = location;
          const path$1 = path.relative(paths.paths.targetDir, error.id);
          const loc = chalk__default.default.cyan(`${path$1}:${line}:${column}`);
          if (text === 'Unexpected "<"' && error.id.endsWith(".js")) {
            msg += `${loc}: ${text}, JavaScript files with JSX should use a .jsx extension`;
          } else {
            msg += `${loc}: ${text}`;
          }
        }
      }
    } else {
      msg += `(plugin ${error.plugin}) ${error}
`;
    }
  } else {
    if (error.loc) {
      const file = `${paths.paths.resolveTarget(error.loc.file || error.id)}`;
      const pos = `${error.loc.line}:${error.loc.column}`;
      msg += `${file} [${pos}]
`;
    } else if (error.id) {
      msg += `${paths.paths.resolveTarget(error.id)}
`;
    }
    msg += `${error}
`;
    if (error.url) {
      msg += `${chalk__default.default.cyan(error.url)}
`;
    }
    if (error.frame) {
      msg += `${chalk__default.default.dim(error.frame)}
`;
    }
  }
  return msg;
}
async function rollupBuild(config) {
  try {
    const bundle = await rollup.rollup(config);
    if (config.output) {
      for (const output of [config.output].flat()) {
        await bundle.generate(output);
        await bundle.write(output);
      }
    }
  } catch (error) {
    throw new Error(formatErrorMessage(error));
  }
}
const buildPackage = async (options) => {
  try {
    const { resolutions } = await fs__default.default.readJson(
      paths.paths.resolveTargetRoot("package.json")
    );
    if (resolutions?.esbuild) {
      console.warn(
        chalk__default.default.red(
          'Your root package.json contains a "resolutions" entry for "esbuild". This was included in older @backstage/create-app templates in order to work around build issues that have since been fixed. Please remove the entry and run `yarn install`'
        )
      );
    }
  } catch {
  }
  const rollupConfigs = await config.makeRollupConfigs(options);
  await fs__default.default.remove(paths.paths.resolveTarget("dist"));
  const buildTasks = rollupConfigs.map(rollupBuild);
  if (options.outputs.has(types.Output.types) && options.useApiExtractor) {
    buildTasks.push(buildTypeDefinitions.buildTypeDefinitions());
  }
  await Promise.all(buildTasks);
};

exports.buildPackage = buildPackage;
exports.formatErrorMessage = formatErrorMessage;
//# sourceMappingURL=packager.cjs.js.map
